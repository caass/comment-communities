function sleep(ms){return new Promise(resolve=>setTimeout(resolve,ms))}class getNewComments{constructor(callback){this.gettingComments=!1,this.callback=callback}async start(){let callback=this.callback;for(this.gettingComments=!0;this.gettingComments;)await sleep(1e3),d3.json("https://www.reddit.com/r/all/comments/.json?limit=100",function(error,data){if(error)throw error;callback(data)})}stop(){this.gettingComments=!1}test(){console.log("Getting new comments...");let callback=this.callback;d3.json("https://www.reddit.com/r/all/comments/.json?limit=100",function(error,data){if(error)throw error;callback(data),console.log("Got comments!")})}}function trimResponseToRelevantData(jsonResponse){return outputObject={after:jsonResponse.data.after,comments:[]},comments=jsonResponse.data.children,comments.forEach(function(commentObject){outputObject.comments.push({id:commentObject.data.id,body:commentObject.data.body,author:commentObject.data.author,link:commentObject.data.permalink,subreddit:commentObject.data.subreddit})}),outputObject}function addNewCommentsToArray(newCommentsObject){let color=d3.scaleOrdinal(d3.schemeCategory20);newCommentsObject.comments.forEach(function(comment){let subIndex=function(subredditName){for(var i=0;i<subreddits.length;i++)if(subreddits[i].id===subredditName)return i;return!1}(comment.subreddit);if(subIndex){let commentExists=!1;for(let i=0;i<subreddits[subIndex].comments.length;i++)subreddits[subIndex].comments[i].id===comment.id&&(commentExists=!0);commentExists||(subreddits[subIndex].radius+=1,subreddits[subIndex].comments.push(comment))}else subreddits.push({id:comment.subreddit,radius:3,comments:[comment],color:color(Math.floor(20*Math.random())),x:0,y:0,vx:0,vy:0})})}function updateBubbles(){console.log("update");d3.select("svg");let bubble=d3.select("g").selectAll("circle").data(subreddits);bubble.exit().remove(),bubble.enter().append("a").attr("data-toggle","popover").attr("title",function(d){return d.id}).attr("data-content",generatePopoverContents).attr("data-container",".container-fluid").attr("data-html","true").append("circle").attr("r",function(d){return d.radius}).attr("fill",function(d){return d.color}),simulation.nodes(subreddits).on("tick",function(e){bubble.attr("cx",function(d){return d.x}).attr("cy",function(d){return d.y}).attr("r",function(d){return d.radius})}),simulation.alphaTarget(.4).restart()}function callbackWrapper(data){trimmedResponse=trimResponseToRelevantData(data),addNewCommentsToArray(trimmedResponse),commentGetter.gettingComments&&(updateBubbles(),updateBubbles())}function getSvgWrapDimensionsForViewBox(){var h=$("#svg-wrap").height(),w=$("#svg-wrap").width();return Math.round(-.5*w)+" "+Math.round(-.5*h)+" "+w+" "+h}function generatePopoverContents(d){var outputText="",comments=d.comments;return outputText+='<p class="lead mb-1">'+comments.length+" comment"+(1===comments.length?"":"s")+' so far.</p><ul class="list-unstyled">',comments.forEach(function(comment){outputText+='<li><a target="_blank" href="https://reddit.com'+comment.link+'">',outputText+=comment.body.split(" ").slice(0,3).join(" ")+"...",outputText+="</a></li>"}),outputText+"</ul>"}$("#startStopButton").on("click",function(){$("#svg-wrap").has("p")&&$("#svg-wrap").children().fadeOut(250).promise().done(function(){$("#svg-wrap").children().remove();var heightUnderNav=$(window).height()-$(".navbar").outerHeight();$("#svg-wrap").height(heightUnderNav),$("#svg-wrap").css("padding","0"),d3.select("#svg-wrap").append("svg").attr("viewBox",getSvgWrapDimensionsForViewBox()).attr("preserveAspectRatio","xMinYMin meet");let svg=d3.select("svg");simulation.force("repel",d3.forceManyBody().strength(-20)).force("centerX",d3.forceX(0).strength(.3)).force("centerY",d3.forceY(0).strength(.3)).force("collide",d3.forceCollide(function(d){return d.radius+Math.sqrt(d.radius)}));let bubble=svg.append("g").attr("class","bubbles").selectAll("circle").data(subreddits).enter().append("a").attr("data-toggle","popover").attr("title",function(d){return d.id}).attr("data-content",generatePopoverContents).attr("data-container",".container-fluid").attr("data-html","true").append("circle").attr("r",function(d){return d.radius}).attr("fill",function(d){return d.color});$('[data-toggle="popover"]').popover(),simulation.nodes(subreddits).on("tick",function(e){bubble.attr("cx",function(d){return d.x}).attr("cy",function(d){return d.y}).attr("r",function(d){return d.radius})})}),$(this).toggleClass("btn-success"),$(this).toggleClass("btn-outline-danger"),$(this).hasClass("btn-success")?($(this).text("Get Comments"),commentGetter.stop(),simulation.alphaTarget(0).restart()):($(this).text("Stop"),commentGetter.start())}),$(window).on("resize",function(){var heightUnderNav=$(window).height()-$(".navbar").outerHeight();$("#svg-wrap").height(heightUnderNav),d3.select("svg").attr("viewBox",getSvgWrapDimensionsForViewBox())}),$(".reset-visualization").on("click",function(){subreddits=[],d3.select("g").remove()}),$("body").on("click",function(e){$("[data-toggle=popover]").each(function(){$(this).is(e.target)||0!==$(this).has(e.target).length||0!==$(".popover").has(e.target).length||$(this).popover("hide")})});var subreddits=[],commentGetter=new getNewComments(callbackWrapper),simulation=d3.forceSimulation();